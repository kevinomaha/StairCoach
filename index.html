<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Stair Race Pacer</title>
  <meta name="description" content="Real-time audio pacing for stair races with music, voice prompts, and floor cues" />
  <meta name="theme-color" content="#7c5cff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="StairCoach" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Stair Race Pacer</h1>
      <p class="sub">Phone-friendly pacer with real music + spoken motivation every minute.</p>
      <div class="row" style="margin-top:10px;">
        <span class="pill">üéµ Jamendo music</span>
        <span class="pill">üó£Ô∏è Voice prompts</span>
        <span class="pill">‚è±Ô∏è Minute checks</span>
        <span class="pill">üè¢ Floor cues</span>
      </div>
      <p class="hint">Tip: iPhone requires a tap to start audio. Keep the screen awake if possible.</p>
    </div>

    <div class="card">
      <div class="grid">
        <label>
          Floors
          <input id="floors" type="number" min="1" step="1" value="40" />
        </label>
        <label>
          Total time (mm:ss)
          <input id="time" type="text" value="8:00" />
        </label>

        <label>
          Prompt style
          <select id="style">
            <option value="coach">Coachy + direct</option>
            <option value="hype">High energy hype</option>
            <option value="calm">Calm & steady</option>
          </select>
        </label>

        <label>
          Music source
          <select id="musicSource">
            <option value="jamendo">Jamendo (real music)</option>
            <option value="off">Off</option>
          </select>
        </label>

        <label>
          Jamendo mood/tag
          <select id="jamendoTag">
            <option value="pop">pop</option>
            <option value="rock">rock</option>
            <option value="country">country</option>
            <option value="jazz">jazz</option>            
            <option value="electronic">electronic</option>
            <option value="dance">dance</option>
            <option value="house">house</option>
            <option value="hiphop">hiphop</option>
          </select>
        </label>

        <label class="row" style="justify-content:space-between;">
          <span>Voice prompts</span>
          <input id="voiceOn" type="checkbox" checked />
        </label>

        <label class="row" style="justify-content:space-between;">
          <span>Floor callouts</span>
          <input id="floorCalls" type="checkbox" checked />
        </label>

        <label class="row" style="justify-content:space-between;">
          <span>Duck music during voice</span>
          <input id="duckMusic" type="checkbox" checked />
        </label>

        <label>
          Music volume
          <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.60" />
        </label>

        <label>
          Voice volume
          <input id="voiceVol" type="range" min="0" max="1" step="0.01" value="1" />
        </label>
      </div>

      <div class="btns" style="margin-top:12px;">
        <button id="startBtn">Start</button>
        <button id="pauseBtn" class="secondary" disabled>Pause</button>
        <button id="stopBtn" class="secondary" disabled>Stop</button>
        <button id="loadTrackBtn" class="secondary" type="button">Load new track</button>
      </div>

      
    </div>

    <div class="card big">
      <div>
        <div class="timer" id="timer">08:00</div>
        <div class="sub" id="phase">Ready</div>
      </div>
      <div class="stats">
        <div class="stat"><div class="k">Target pace</div><div class="v" id="pace">‚Äî</div></div>
        <div class="stat"><div class="k">Next minute prompt</div><div class="v" id="nextMinute">‚Äî</div></div>
        <div class="stat"><div class="k">Next floor cue</div><div class="v" id="nextFloor">‚Äî</div></div>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:8px;">Coach log</div>
      <div class="log" id="log"></div>
    </div>
  </div>

<script type="module">
  import { VoiceManager } from './js/voice.js';
  import { MusicManager } from './js/music.js';
  import { config } from './js/config.js';

  (() => {
    // Use client_id from config
    const JAMENDO_CLIENT_ID = config.jamendoClientId;

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");

    function log(msg) {
      const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
      const line = document.createElement("div");
      line.textContent = `[${t}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function parseTimeMMSS(s) {
      const m = String(s).trim().match(/^(\d+)\s*:\s*([0-5]\d)$/);
      if (m) return (+m[1] * 60) + (+m[2]);
      const asNum = Number(String(s).trim());
      if (Number.isFinite(asNum) && asNum > 0) return Math.round(asNum);
      return 8 * 60;
    }

    function fmtTime(sec) {
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    // ---------- Voice Manager ----------
    const voiceManager = new VoiceManager({
      getElementFn: $,
      getLogFn: log,
      clampFn: clamp
    });

    // ---------- Music Manager ----------
    const musicManager = new MusicManager({
      clientId: JAMENDO_CLIENT_ID,
      getElementFn: $,
      getLogFn: log
    });
    musicManager.setVoiceManager(voiceManager);

  // ---------- Pacer logic ----------
  let totalSeconds = 8*60;
  let totalFloors = 40;

  let started = false;
  let paused = false;

  let t0 = 0;            // performance.now start time
  let pausedAt = 0;      // performance.now pause time
  let pauseAccum = 0;    // ms

  let raf = null;
  let nextMinuteMark = 60;  // seconds elapsed threshold
  let nextFloorMark = 1;    // floor number threshold
    let lastAnnouncementTime = -Infinity; // Track last voice announcement
    const bank = {
      coach: [
        `Minute ${min}. Stay tall. Drive the knees. You're on pace.`,
        `Minute ${min}. Smooth steps. Light hands on the rail. Breathe.`,
        `Minute ${min}. Controlled power. You can hold this.`,
        `Minute ${min}. Quick feet. Strong core. Keep moving.`
      ],
      hype: [
        `Minute ${min}! Let's go! You‚Äôre hunting floors. Keep it loud!`,
        `Minute ${min}! Push push push! You‚Äôre stronger than the burn!`,
        `Minute ${min}! You own this staircase. Attack the next set!`,
        `Minute ${min}! Big energy! Keep the cadence and fly!`
      ],
      calm: [
        `Minute ${min}. Steady rhythm. In through the nose, out through the mouth.`,
        `Minute ${min}. Relax the shoulders. Keep your breath smooth.`,
        `Minute ${min}. One step at a time. You‚Äôre doing great.`,
        `Minute ${min}. Stay consistent. Calm power.`
      ]
    };

    const pick = bank[style][(min - 1) % bank[style].length];
    if (remaining === 1) return `${pick} One minute left ‚Äî finish strong.`;
    if (remaining === 0) return `${pick} Final push ‚Äî empty the tank!`;
    return pick;
  }

  function floorCalloutText(floor, floorsTotal, style) {
    const pct = Math.round((floor / floorsTotal) * 100);
    if (floor === floorsTotal) return `Floor ${floor}. Finish!`;
    if (style === "hype") return `Floor ${floor}! ${pct} percent. Keep climbing!`;
    if (style === "calm") return `Floor ${floor}. ${pct} percent. Smooth and steady.`;
    return `Floor ${floor}. ${pct} percent. On pace.`;
  }

  function updateDerivedUI() {
    totalFloors = Math.max(1, Math.floor(Number($("floors").value || 40)));
    totalSeconds = Math.max(10, parseTimeMMSS($("time").value));
    $("timer").textContent = fmtTime(totalSeconds);

    const floorsPerMin = totalFloors / (totalSeconds / 60);
    const secPerFloor = totalSeconds / totalFloors;

    $("pace").textContent = `${floorsPerMin.toFixed(2)} floors/min ‚Ä¢ ${secPerFloor.toFixed(1)} sec/floor`;
  }

  async function start() {
    updateDerivedUI();

    // Prime audio + speech (mobile requires a tap)
    try {
      await musicManager.ensureForStart();
    } catch (e) {
      log(`Music error: ${e.message}. Continuing without music.`);
      musicManager.stop();
    }

    const minsTotal = Math.ceil(totalSeconds / 60);
    const style = $("style").value;

    started = true; paused = false;
    pauseAccum = 0; t0 = performance.now();
    nextMinuteMark = 60;
    nextFloorMark = 1;

    $("startBtn").disabled = true;
    $("pauseBtn").disabled = false;
    $("stopBtn").disabled = false;
    $("phase").textContent = "Go time";

    log("START");
    voiceManager.speak(style === "hype"
      ? "Let‚Äôs go! Forty floors. Lock the rhythm. Start climbing!"
      : style === "calm"
        ? "Start steady. Find your rhythm. You‚Äôve got this."
        : "Start strong. Hold your pace. One minute at a time.");

    $("nextMinute").textContent = "1:00";
    const secPerFloor = totalSeconds / totalFloors;
    $("nextFloor").textContent = `${fmtTime(secPerFloor)} (Floor 1)`;

    tick();
  }

  function pause() {
    if (!started) return;
    if (!paused) {
      paused = true;
      pausedAt = performance.now();
      try { musicManager.pause(); } catch {}
      voiceManager.cancel();
      $("pauseBtn").textContent = "Resume";
      $("phase").textContent = "Paused";
      log("PAUSE");
    } else {
      paused = false;
      pauseAccum += performance.now() - pausedAt;
      try { musicManager.play(); } catch {}
      $("pauseBtn").textContent = "Pause";
      $("phase").textContent = "Go time";
      log("RESUME");
      tick();
    }
  }

  function stop() {
    if (!started) return;
    started = false; paused = false;
    musicManager.stop();
    voiceManager.cancel();

    $("startBtn").disabled = false;
    $("pauseBtn").disabled = true;
    $("stopBtn").disabled = true;
    $("pauseBtn").textContent = "Pause";
    $("phase").textContent = "Ready";

    cancelAnimationFrame(raf);
    raf = null;

    updateDerivedUI();
    $("nextMinute").textContent = "‚Äî";
    $("nextFloor").textContent = "‚Äî";
    log("STOP");
  }

  function finish() {
    // keep music on briefly; you can stop if you prefer
    const style = $("style").value;
    $("phase").textContent = "Finished";
    log("FINISH");
    voiceManager.speak(style === "hype"
      ? "Done! You crushed it! Great finish!"
      : "Finished. Great work. Breathe and recover.");
  }

  function tick() {
    if (!started || paused) return;
    const now = performance.now();
    const elapsedMs = now - t0 - pauseAccum;
    const elapsedSec = elapsedMs / 1000;
    const remaining = totalSeconds - elapsedSec;

    $("timer").textContent = fmtTime(remaining);

    const style = $("style").value;
    const minsTotal = Math.ceil(totalSeconds / 60);

    // Floor cues FIRST - they take priority
    let floorAnnouncedThisFrame = false;
    if ($("floorCalls").checked) {
      const secPerFloor = totalSeconds / totalFloors;
      const currentFloor = Math.floor(elapsedSec / secPerFloor);
      
      // Fire announcements for any floors we've just reached
      while (nextFloorMark <= totalFloors && nextFloorMark <= currentFloor) {
        const txt = voiceManager.floorCalloutText(nextFloorMark, totalFloors, style);
        log(txt);
        voiceManager.speak(txt);
        lastAnnouncementTime = elapsedSec;
        floorAnnouncedThisFrame = true;
        nextFloorMark++;
      }

      // Show time to next floor
      if (nextFloorMark <= totalFloors) {
        const nextFloorTime = nextFloorMark * secPerFloor;
        const timeToNextFloor = Math.max(0, nextFloorTime - elapsedSec);
        $("nextFloor").textContent = `${fmtTime(timeToNextFloor)} (Floor ${nextFloorMark})`;
      } else {
        $("nextFloor").textContent = "Done";
      }
    } else {
      $("nextFloor").textContent = "Off";
    }

    // Minute prompts - AFTER floors, with buffer to avoid conflicts
    // Skip if floor announcement just happened (within 2 seconds)
    const timeSinceLastAnnouncement = elapsedSec - lastAnnouncementTime;
    if (elapsedSec >= nextMinuteMark && nextMinuteMark <= totalSeconds && timeSinceLastAnnouncement > 2) {
      const minNum = Math.floor(nextMinuteMark / 60);
      const prompt = voiceManager.buildMinutePrompt(minNum, minsTotal, style);
      log(prompt);
      voiceManager.speak(prompt);
      lastAnnouncementTime = elapsedSec;
      nextMinuteMark += 60;
    }

    // Next minute UI
    if (nextMinuteMark <= totalSeconds) {
      $("nextMinute").textContent = fmtTime(nextMinuteMark - elapsedSec);
    } else {
      $("nextMinute").textContent = "‚Äî";
    }

    if (remaining <= 0) {
      $("timer").textContent = "00:00";
      finish();
      return;
    }

    raf = requestAnimationFrame(tick);
  }

  // ---------- Wire up controls ----------
  function init() {
    updateDerivedUI();
    log("Ready. Set floors/time then tap Start.");

    $("floors").addEventListener("input", () => { if (!started) updateDerivedUI(); });
    $("time").addEventListener("input", () => { if (!started) updateDerivedUI(); });

    $("musicVol").addEventListener("input", (e) => {
      const v = Number(e.target.value);
      musicManager.setVolume(v);
    });

    $("voiceVol").addEventListener("input", (e) => { voiceManager.setVoiceVolume(e.target.value); });

    $("startBtn").addEventListener("click", () => start());
    $("pauseBtn").addEventListener("click", pause);
    $("stopBtn").addEventListener("click", stop);

    $("loadTrackBtn").addEventListener("click", async () => {
      if ($("musicSource").value !== "jamendo") {
        log("Switch Music source to Jamendo to load a track.");
        return;
      }
      try {
        await musicManager.loadTrack();
      } catch (e) {
        log(`Jamendo error: ${e.message}`);
      }
    });

    // Warm up voices list
    voiceManager.warmUpVoices();
    }

    init();
  })();
</script>
</body>
</html>
